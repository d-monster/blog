
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>MPLS | dmonster&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="MPLS ARP  地址解析协议：用已知6的ip地址来求未知目的mac地址  arp隶属于icmp协议，icmp：互联消息控制管理协议  icmp通过一系列消息实现各种工具功能，如ping和arp  arp包含两个消息 一个叫广播请求，一个叫单播回应  proxy arp ：代理arp  路由器接口默认启用代理arp，代理arp替代目标给请求者回应，同时代理arp帮助路由器请求目标mac   实际">
<meta name="keywords" content="CCIE">
<meta property="og:type" content="article">
<meta property="og:title" content="MPLS">
<meta property="og:url" content="http://dmonster.top/2017/11/24/MPLS/index.html">
<meta property="og:site_name" content="dmonster&#39;s blog">
<meta property="og:description" content="MPLS ARP  地址解析协议：用已知6的ip地址来求未知目的mac地址  arp隶属于icmp协议，icmp：互联消息控制管理协议  icmp通过一系列消息实现各种工具功能，如ping和arp  arp包含两个消息 一个叫广播请求，一个叫单播回应  proxy arp ：代理arp  路由器接口默认启用代理arp，代理arp替代目标给请求者回应，同时代理arp帮助路由器请求目标mac   实际">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-03-15T02:02:30.559Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MPLS">
<meta name="twitter:description" content="MPLS ARP  地址解析协议：用已知6的ip地址来求未知目的mac地址  arp隶属于icmp协议，icmp：互联消息控制管理协议  icmp通过一系列消息实现各种工具功能，如ping和arp  arp包含两个消息 一个叫广播请求，一个叫单播回应  proxy arp ：代理arp  路由器接口默认启用代理arp，代理arp替代目标给请求者回应，同时代理arp帮助路由器请求目标mac   实际">
  
    <link rel="alternative" href="/atom.xml" title="dmonster&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
</head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">dmonster&#39;s blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Hello my world!</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/sitemap.xml">sitemap</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="dmonster.top">
        </form>
      </div>
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main"><article id="post-MPLS" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/11/24/MPLS/" class="article-date">
  <time datetime="2017-11-23T16:19:25.000Z" itemprop="datePublished">2017-11-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/笔记/">笔记</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      MPLS
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      <!-- Table of Contents -->
      
        <div id="toc" class="toc-article">
          <strong class="toc-title">文章目录</strong>
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#MPLS"><span class="toc-number">1.</span> <span class="toc-text">MPLS</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MPLS-VPN"><span class="toc-number">2.</span> <span class="toc-text">MPLS VPN</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#mpls-vpn的配置流程"><span class="toc-number">2.1.</span> <span class="toc-text">mpls vpn的配置流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mpls-vpn中的ospf特性"><span class="toc-number">2.2.</span> <span class="toc-text">mpls vpn中的ospf特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mpls-vpn-跨域"><span class="toc-number">2.3.</span> <span class="toc-text">mpls vpn 跨域</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考书籍"><span class="toc-number">2.4.</span> <span class="toc-text">参考书籍</span></a></li></ol></li></ol>
        </div>
      
        <h1 id="MPLS"><a href="#MPLS" class="headerlink" title="MPLS"></a>MPLS</h1><ol>
<li><p>ARP</p>
<p> 地址解析协议：用已知6的ip地址来求未知目的mac地址</p>
<p> arp隶属于icmp协议，icmp：互联消息控制管理协议</p>
<p> icmp通过一系列消息实现各种工具功能，如ping和arp</p>
<p> arp包含两个消息 一个叫广播请求，一个叫单播回应</p>
</li>
<li><p>proxy arp ：代理arp</p>
<p> 路由器接口默认启用代理arp，代理arp替代目标给请求者回应，同时代理arp帮助路由器请求目标mac   实际上是将数据包引向下一跳</p>
</li>
<li><p>路由器数据转发时的帧头重写</p>
<p> pc0 -》pc1</p>
<p> D-mac s-mac<br> 12-1  12-a<br> d-ip  s-ip<br> 1.2   2.2</p>
<p> 路由器在数据转发过程中先路由，路由完毕后必须对帧头重写，重写的目的是</p>
<p> 将目标mac换成路径沿途下一跳设备的mac地址，帮助数据往前走一步    </p>
<p> 将源mac替换为路由器出口的mac地址，为了数据返回的时候可以靠近目的地</p>
</li>
<li><p>路由器数据转发机制</p>
<ol>
<li><p>进程转发 process forword ： 淘汰了，过老的技术</p>
<p> 路由器的每一次arp请求都是通过源于终端的流量触发的，并且请求结果不会缓存下来，相同设备通讯，需要反复的重复请求</p>
</li>
<li><p>缓存转发 cache forword 一次路由多次交换 ： 淘汰</p>
<p> rewrite switch 路由器创建arp缓存表，缓存被请求得到的目标主机mac地址，相同设备通讯，就不需要额外的重复请求</p>
<p> 无论进程转发还是缓存转发，第一次arp请请求都是通过终端流量触发</p>
</li>
<li><p>快速转发 cef 思科快速转发 </p>
<ol>
<li><p>cef详解</p>
<ol>
<li><p>cef两张表</p>
<p> cef默认开启，如果希望关闭cef : no ip cef</p>
<p> FIB :forwardin information base :转发信息库</p>
<p> FIB 会周期性检查RIB（路由表），并且渎职下载RIB内容</p>
<p> FIB假设所有目标网络都是要被访问的，FIB主动对目标网络下一跳做arp探查（请求）</p>
<p> CEF假设RIB中目标网络所包含的主机都会被访问，所以CEF就提前对目标网络的下一跳做ARP请求，并将结果缓存，这样就不需要流量出发ARP请求</p>
<p> ADJ-table : 邻接表</p>
<p> 该表中存放这目标网络，下一跳，以及出口和需要替换的帧头信息</p>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<pre><code>4. 路由器上RIB、FIB、ADJ-table关系

    RIB时FIB素材的提供者，ADJ-table的内容来自于FIB的请求结果，数据抵达后先看FIB 利用FIB和ADJ-table 完成数据转发

- cef缺陷

    cef本身的匹配查找还是逐条最长匹配，所以效率特别低
</code></pre><ol>
<li><p>mpls</p>
<ol>
<li><p>mpls概述</p>
<p> 多协议标签交换 ，是一种数据转发机制，是为了取代ip转发</p>
<p> 现在mpls已经和iP完满融合</p>
<p> mpls是基于CEF的</p>
<p> OSI 7层模型上看，mpls是2.5层技术      帧头/包头/断头/负载/帧尾</p>
<p> mpls在枕头的后面，包头的前面插入了一个新的头部信息     帧头/标签/包头/断头/负载/帧尾</p>
<p> ！！补充</p>
<ol>
<li><p>路由器收到数据后如何判断使用路由转发还是用mpls转发</p>
<p> 帧头里包含了一个以太网帧类型字段，不同数值的意义不一样</p>
</li>
</ol>
</li>
<li><p>mpls标签内容</p>
<p> mpls标签其实就是数据转发的依据，类似mac地址和ip地址概念</p>
<p> mpls标签长度32bit，4字节。</p>
<p> 前20bit 标签取值范围   约等于与100w个标签<br> 紧接着1bit为栈底位，最早被压入数据头部的标签，栈底位为1，含义是告诉路由器，读完该标签没必要在往后读了，因为后面是包头了</p>
<p> 再接着3bit为EXP（体验位）：3bit 0-7 8个数值，代表了不同的转发优先级别</p>
<p> 最后8bit为ttl（time to live 生存周期） </p>
</li>
<li><p>mpls的模式</p>
<ol>
<li>帧模式 ：frame mode 以太网里启用mpls，label插在帧头后面</li>
<li>信元模式： cell mode ：同步传输网络中（atm）启用mpls，label插在信元头后面</li>
</ol>
</li>
<li><p>mpls术语</p>
<ol>
<li>LABEL：标签</li>
<li><p>LSR：标签交换路由器   启用mpls的路由器</p>
<ol>
<li>入栈LSR：启用了mpls，接收了ip数据，压入标签，转发出去</li>
<li>连路中LSR：接收了带有标签的数据，完全依赖标签转发数据</li>
<li><p>出栈LSR：需要将标签移除，将数据还原传递给ip网络</p>
<p>入栈LSR和出栈LSR是相对的</p>
</li>
</ol>
</li>
<li><p>LSP label switch path：标签交换路径</p>
<p> lsp就是标签关联后形成的源到目的的逻辑通路，类似路由路径</p>
</li>
<li><p>TDP、LDP</p>
<ol>
<li>TDP：标记分发协议</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<pre><code>    2. LDP：标签分发协议

    TDP和LDP实际上就是负责标签分配，分发，关联，维护的技术

5. 标签的操作

    压入，交换，移出，弹出
</code></pre><ol>
<li><p>作用</p>
<ol>
<li>是一个更快速的数据转发技术</li>
<li>能减少核心网洛内参与bgp的设备数量和减少bgp peer关系</li>
</ol>
</li>
<li><p>LDP</p>
<ol>
<li><p>LDP的作用</p>
<ol>
<li><p>LDP帮助直连设备形成LDP邻居关系</p>
<p> LDP的邻居是通过HELLO消息的发送发现的</p>
<p> LDP HELLO消息是基于UDP，目标端口646</p>
<p> LDP的邻居关系是通过HEOOL消息建立的</p>
<p> LDP邻居关系的建立基于TCP，目标端口646</p>
<p> LDP RID概念：启用LDP设备的route-id，RID是LDP邻居关系建立时所用的的，所以必须可达</p>
</li>
<li><p>LDP负责给FIB表中目标网络分配标签</p>
<p> 0~15是保留的，FIB表中的路由条目对应的目标网络LDP是无法进行标签分配的</p>
<p> 本地标签 ： LL</p>
</li>
<li><p>LDP需要负责将本地网络对应的本地标签分发给其他LDP邻居</p>
<p> LDP在分发标签信息的时候，两个方式：</p>
<ol>
<li>上游主动：ATM沿用</li>
<li><p>下游主动：以太网络沿用</p>
<p>上下游按照数据流方向做判断</p>
<p>LDP标签分发的实际机制：本地网络对应本地标签给所有邻居。</p>
</li>
</ol>
</li>
<li><p>标签的关联</p>
<p> 标签关联是目标网路、本地标签及对应的远程标签、下一跳、出口、二层重写信息关联而来</p>
</li>
</ol>
<ul>
<li><p>注意</p>
<p>  bound address : 被绑定地址</p>
<p>  参与MPLS设备的RID和启用MPLS的接口IP都是绑定地址</p>
<p>  绑定地址会随着本地标签共享出去</p>
<p>  设备提供的绑定地址与路由表中的下一跳匹配了，那么设备提供的远程标签就可以关联</p>
</li>
</ul>
<ol>
<li><p>标签路径的维护</p>
<p> LSP其实和路由路径是重叠的</p>
<p> 路由路径如果发生变化，RIB一定变化，FIB表随之变化，LDP本身又基于FIB表，所以一切跟着变</p>
</li>
</ol>
</li>
<li><p>特殊的标签概念</p>
<ol>
<li><p>到数第二跳 POP label </p>
<p> POP LABEL 是当前路由器分配给本地直连网络的标签</p>
<p> POP LABEL 最终会成为倒数第二跳的远程标签，而这个POP LABEL概念是弹掉标签，数据回复成ip包，提高转发效率（实际上就是恢复成ip数据包丢给倒数第一条设备，帮助倒数第一跳设备少查一次标签转发信息库，提高数据转发效率）</p>
</li>
<li><p>UNTAG 标签  未标记标签</p>
<p> 一半MPLS核心网底层协议是ospf的时候出现</p>
<p> 当前设备找不到对应的目标网络远程标签，就会分配untag</p>
<p> 远程标签如果是untag，所有标签被移除，在传递给下一跳</p>
</li>
<li><p>路由器标签操作动作</p>
<ol>
<li>压入</li>
<li>交换</li>
<li>弹出</li>
<li>移除</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<pre><code>4. MPLS的表项

    1. LIB：标签信息库

        所有目标网络的本地标签信息，和邻居分享过来的远程标签都存储在这

    2. 标签转发信息库

        目标网络本地标签、本地标签、关联结果、出口、下一跳 存放于这里

5. MPLS表项与RIB、FIB的关系


6. 补充知识

    MPLS的控制平台与数据传输平台

    MPLS的控制平台负责完成所有数据传输所需的表项

    MPLS的传输平台

7. MPLS的配置流程

    1. 确保CEF开启

            router（config）# ip cef

    2. 设定MPLS的相关参数

            mpls label protocol &lt;ldp/tdp&gt;   //选择MPLS的标签分配分发协议

            mpls ldp router-id &lt;looback x&gt;    //手动设定MPLS的LDP RID

            mpls label range &lt;xx yy&gt;           //设定MLS的标签取值范围

        这些命令都是可选配置，不是一定要配置

    3. 接口下启用MPLS

            interface x
            ip mpls


8. MPLS校验流程

        show mpls ldp discovery detail  //确认MPLS LDP是否发现邻居

        show mpls ldp neighbor            //确认MPLS LDP 邻居表是否建立

        show mpls ldp binding              // 查看MPLS LIB表

        show mpls forwarding-table      //查看MPLS LFIB表

        show adj detail

9. 网络中哪些接口和设备需要参与和启用MPLS

    需要形成LDP邻居关系的，需要分发标签的，才启用MPLS


10. 补充知识

    MPLS transport address ： MPLS传输地址

    MPLS邻接关系，实际上是利用传输地址完成的，LDP RID 默认就是传输地址

    no host router to transport address ：这个提示不是报错，而是说没有主机路由抵达

    no route to transport addr:这个提示%100报错



11. 补充知识

    1. 偏移列表

        偏移列表是rip和eigrp用的，用于将路由封信的开销进行累加

        先编写acl，再在rigrp下offset

            acc 2 per 2.2.2.0 0.0.0.255
            router eigrp 1
            offset 1 in 100000 fa 0/0
            net 12.12.12.0 0.0.0.255
</code></pre><h1 id="MPLS-VPN"><a href="#MPLS-VPN" class="headerlink" title="MPLS VPN"></a>MPLS VPN</h1><ol>
<li><p>什么是vpn </p>
<p> 虚拟的专用网络，VPN可以分成两种： 数据加密、对等体认证</p>
<pre><code>不加密数据，也不做认证，只组建专有网络
</code></pre></li>
<li><p>MPLS VPN的作用</p>
<p> 运营商网络是MPLS VPN的核心，通过共享客户网络的路由信息，实现专用通信访问</p>
</li>
<li><p>MPLS VPN中的术语</p>
<ol>
<li>p-network   网络服务提供商<ol>
<li>p 设备  服务提供商核心网络核心设备</li>
<li>pe设备  服务提供商边界设备</li>
</ol>
</li>
<li>c-network  客户网络<ol>
<li>ce设备   客户边界设备</li>
</ol>
</li>
<li><p>vrf 虚拟路由转发表    </p>
<p> vrf是位于pe设备上的，由pe设备针对不同的c-network创建</p>
<p> vrf用来隔离和区分、存储不同c-network的路由信息        </p>
</li>
<li><p>MP-bgp 多协议的bgp</p>
<p> mp-bgp就是为了mpls-vpn出现的，mp-bgp实际上是在传统的bgpv4基础上激活的。</p>
<p> mp-bgp出现就是为了帮助pe设备共享vrf的路由信息</p>
</li>
<li><p>vrf中的rd与rt</p>
<ol>
<li><p>RD：路由区分值</p>
<p> 格式是xx：xx ，不同vrf的相同路由进入mp-bgp转发表后会利用rd来区分</p>
</li>
<li><p>RT：路由目标值</p>
<p> RT值是两个：导出RT值、导入RT值，格式也是x:x</p>
<p> vrf路由进入mp-bgp，编程mp-bgp更新是，携带导出RT值，对端接收到mp-bgp更新后，利用导出rt值和导入rt值进行匹配比较，确认路由进入哪个vrf</p>
</li>
</ol>
<ul>
<li><p>vrf rd rt的关系</p>
<p>  mp-bgp允许rd和rt成为路由更新属性的一部分，传统bgp做不到</p>
<p>  mp-bgp共享的路由更新叫vpnv4更新</p>
</li>
</ul>
</li>
</ol>
</li>
<li><p>MPLS VPN中双标签的作用</p>
<ol>
<li><p>MPLS VPN中的栈顶标签 是帮助数据流穿越p-net抵达配pe设备</p>
<p> 栈顶标签是p-net中ldp负责分配，分发，关联的</p>
</li>
<li><p>MPLS VPN中的栈底标签</p>
<p> vrf的路由条目信息进入mp-bgp转发表，变成bgp路由更新时，由bgp分配标签，该标签记录了目标网络与vrf的关联关系，并且在最终数据的传递是帮助数据抵达正确vrf</p>
</li>
</ol>
</li>
<li><p>ce设备如何和pe设备交换路由信息</p>
<ol>
<li><p>静态路由</p>
<p> ce设备上静态路由的设置只需要将下一跳指向pe即可</p>
<p> pe设备上静态路由的设置</p>
<pre><code>ip route vrf &lt;name&gt; &lt;目标网络&gt; &lt;下一跳&gt;
</code></pre><p> pe设备查看vrf表</p>
<pre><code>show ip vrf &lt;name&gt;
</code></pre><p> pe设备需要ping c-network</p>
<pre><code>ping vrf &lt;name&gt; &lt;目标网络&gt;
</code></pre></li>
<li><p>利用动态路由协议</p>
<ol>
<li><p>rip</p>
<p> ce上rip的配置是常规的</p>
<p> pe上的rip配置</p>
<pre><code>router rip
address-family ipv4 vrf &lt;name&gt;
no auto-summary
version 2
network &lt;主网信息&gt;
</code></pre></li>
<li><p>eigrp</p>
<p> ce上eigrp的配置常规</p>
<p> pe设备上</p>
<pre><code>router eigrp&lt;as-id&gt;
address-family ipv4 vrf &lt;name&gt;
no auto-summary
autonomous-system &lt;as-id&gt;  //重申as号
network &lt;xxxxxx&gt;
</code></pre></li>
<li><p>ospf</p>
<p> ce设备上配置常规</p>
<p> pe设备上</p>
<pre><code>router ospf &lt;p-id&gt; vrf &lt;name&gt;
router-id &lt;xxx&gt;
network &lt;xxxx&gt; &lt;xxxx&gt; area &lt;id&gt;
</code></pre></li>
<li><p>bgp</p>
<p> ce设备上bgp配置常规</p>
<p> pe设备上bgp的配置</p>
<pre><code>router bgp &lt;as-id&gt;
address-family ipv4 vrf &lt;name&gt;
neighbor &lt;xxx&gt; remote-as &lt;as-id&gt;
</code></pre></li>
</ol>
</li>
</ol>
</li>
</ol>
<ol>
<li>将pe设备上vrf路由带入mp-bgp同时将mp-bgp路由带入vrf（类似双向重分发）</li>
</ol>
<h2 id="mpls-vpn的配置流程"><a href="#mpls-vpn的配置流程" class="headerlink" title="mpls vpn的配置流程"></a>mpls vpn的配置流程</h2><ol>
<li><p>从p-net开始配置</p>
<ol>
<li><p>完成igps的配置</p>
<p> 是为了bgp和ldp的rid 或 对等体地址可达</p>
</li>
<li><p>开启cef完成mpls的配置</p>
</li>
<li><p>完成pe设备上bgp的配置及mp-bgp的激活</p>
<pre><code>router bgp &lt;as-id&gt;
bgp router-id &lt;xxx&gt;
neighbor &lt;peer-address&gt; remote-as &lt;as-id&gt;
neighbor &lt;peer-address&gt; update-source loopback 0
address-family vpnv4 unicast //进入bgp配置模式
neighbor &lt;peer-address&gt; actively    //在原本的对等体基础上激活mp-bp关系
show ip bgp vpnv4 all summary  //查看mp-bgp对等体关系

clear ip bgp vpnv4 unicast 1 soft out   //mpbgp软清除
</code></pre><p> 2和3一定不能配反，否则mpls-vpn无法正常工作</p>
</li>
</ol>
</li>
</ol>
<pre><code>        router bgp &lt;as-id&gt;
        neighbor &lt;peer-address&gt; default-information //向对等体发送一条缺省路由

4. 完成pe设备上vrf的创建，并且将接口划入vrf

        ip vrf &lt;name&gt;     //创建指定名称的vrf表
        rd &lt;x:x&gt;
        route-target &lt;both/import/outport&gt;    //定义了rt的导入导出值
        interface &lt;intf-id&gt;
        ip vrf forwarding &lt;vrfname&gt;  //接口划入vrf（接口划入vrf中，会将ip抹除一次）
        ip address &lt;xxxxx&gt; &lt;xxxxx&gt; 

        show ip vrf   //查看当前设备的vrf以及有没有设备隶属于他

    一定是接口先划入vrf，再加ip
</code></pre><ol>
<li><p>完成c-network的配置</p>
</li>
<li><p>完成ce和pe间的路由信息共享</p>
</li>
<li><p>在pe设备上将vrf路由和mp-bgp路由进行双向重分发    </p>
<ol>
<li><p>静态、rip、eigrp、ospf、重分发进mp-bgp</p>
<p> 如果pe和ce上启用的是bgp，那么不需要重分发</p>
<pre><code>nei &lt;xxxx&gt; allowas-in x   //ebgp防环机制会阻挡路由从ce返回pe，此条命令为 允许学习所带自己as号几次

router bgp &lt;as-id&gt;
address-family ipv4 vrf &lt;name&gt;   //这里的vrf名字一定要对应到c-net
redistribute [&lt;static/eigrp as-id/ospf p-id&gt;]

show ip bgp vpnv4 all  //查看mp-bgp 路由转发表

show ip bgp vpnv4 all label  //查看栈底标签
</code></pre></li>
<li><p>bgp重分发进ospf需：</p>
<pre><code>redistribute bgp &lt;as-id&gt; subnets
</code></pre></li>
</ol>
</li>
</ol>
<ul>
<li><p>注意</p>
<p>  yntag在mpls vpn中会移除所有标签，这会引起数据无法传递，所以如果mpls vpn底层协议是ospf，loopback接口务必 </p>
<pre><code>ip ospf network point-to-point
</code></pre></li>
</ul>
<ul>
<li><p>RT的设置</p>
<p>  RT不管是出，还是入都可以是多个值</p>
</li>
</ul>
<h2 id="mpls-vpn中的ospf特性"><a href="#mpls-vpn中的ospf特性" class="headerlink" title="mpls vpn中的ospf特性"></a>mpls vpn中的ospf特性</h2><ol>
<li><p>ospf超级骨干层</p>
<p> 超级骨干层就是mpls vpn的p-network，pe设备扮演了abr，pe-net在帮助骨干层交换路由信息</p>
</li>
<li><p>pe设备和ce设备启用ospf的限制</p>
<ol>
<li><p>pe和ce间最好是ospf，区域0</p>
<p> pe和ce间如果不是区域0，那么pe只学习相连的ospf区域路由，其他区域路由不学习。这种情况下，pe和ce需要启用ospf的虚链路，来完成pe和ce间非区域0的路由信息共享工作</p>
</li>
</ol>
</li>
<li><p>ospf的路由信息通过p-net共享后的路由类型</p>
<ol>
<li>pe设备连接的相同区域ospf路由信息互换之后，反而是区域间路由</li>
<li>pe设备学习的不同区域的路由通过p-net交换后，依旧是区域间路由</li>
<li>pe设备学习的外部路由通过p-net交换后依旧是外部路由形式</li>
</ol>
</li>
<li><p>mpls vpn的back door路径和路由还原问题</p>
<ol>
<li><p>mpls vpn pe设备上配置sham-link（伪链路）</p>
<p> 伪链路帮助还原相同区域路由</p>
<p> pe配置伪链路，然后帮助pe连接的相同区域进行路由还原</p>
</li>
<li><p>隧道技术</p>
<ol>
<li><p>GRE TUNNEL 路由通用封装</p>
<p> GER通过管理员的配置，对数据额外的进行包头的添加封装。</p>
</li>
</ol>
<ul>
<li><p>补充知识</p>
<ol>
<li>rip，eigrp更新源就是下一跳</li>
<li>ospf更新源实际上是lsa的adv-id（通告者id，通常为该路由所在地的router-id），是溯源的</li>
<li>bgp跟新源判断：ebgp路由；ibgp路由</li>
<li>ospf路由更新开销会被MP-bgp携带，当作路由更新属性传递到对端</li>
</ol>
</li>
</ul>
<ol>
<li><p>伪链路的配置流程</p>
<ol>
<li>pe设备上创建隶属于vrf的loopback，添加ip地址，且掩码为255.255.255.255</li>
<li>pe设备上将划入vrf的环回接口的ip宣告进指定的vrf bgp</li>
<li><p>pe设备vrf ospf下完成伪链路设置</p>
<pre><code>router ospf 1 vrf x
area 0 sham-link &lt;自己环回口ip&gt; &lt;对端环回口ip&gt;
</code></pre></li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="mpls-vpn-跨域"><a href="#mpls-vpn-跨域" class="headerlink" title="mpls vpn 跨域"></a>mpls vpn 跨域</h2><ol>
<li><p>跨域MPLS VPN的定义</p>
<p> C-NEWORK分布在不同的AS，需要交换路由信息，保障连通性。</p>
</li>
<li><p>实现跨域MPLS的办法</p>
<ol>
<li><p>back to back：背靠背方法 或者option A</p>
<ol>
<li><p>bgp关闭rt筛选功能，当前设备没有起用对应的vrf，但是希望mp-bgp接收vpnv4更新的网络</p>
<pre><code>router bgp x
no bgp default router-targetfilter
</code></pre></li>
<li><p>如果设备是mp-bgp的路由反射器，那么设备即便即使没有vrf，没有关闭rt筛选功能，一样学习接路由</p>
</li>
<li>asbr配置vrf，并且和对端asbr形成基于vrf的ebgp peer关系。（互相把对方当作c-net看）-&gt;这样r3就可以不配置关闭筛选功能了</li>
<li><p>注意： rt栈底标签是跟着mp-bgp更新发送出去的</p>
</li>
<li><p>back to back 背靠背跨域mpls vpn的技术特点</p>
<ol>
<li>ASBR都视对方为CE设备，和对方建立VRF的EBGP PEER关系</li>
<li>ASBR不需要相互启用LDP，也不需要MP-BGP</li>
<li>当前设备会给对端ASBR共享的路由一个新的本地栈底标签</li>
<li>数据通讯过程中，ASBR之间数据是不携带标签的，只是一个普通的IP包</li>
</ol>
</li>
</ol>
</li>
<li><p>option B 2A</p>
<p> ASBR上关闭RT 筛选：AS不要创建VRF，但是需要学习VPNV4路由更新。<br> ASBR上建立基于直连网络的MP-BGP对等体关系<br> ASBR对着各自AS内的IBGP PEER配置NEXT-HOP-SELF（在vpnv4下）</p>
<ol>
<li><p>注意</p>
<p> 此方案中，通过mp-bgp共享了各自as的栈底标签，那么两个asbr会将栈底标签关联，形成lsp，传递数据</p>
<p> ASBR会给各自AS内的BGP路由，重新分配一个栈底标签，共享到对端。</p>
<p> RD值会当做RT值走（关掉RT值筛选后）show  ip bgp vpnv4 all 8.8.8.8</p>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<pre><code>3. option B 2B

    ASBR关闭RT筛选

    ASBR直连网络启用MPLS 

    ASBR对着对端LOOPBACK 0接口配置静态路由

    ASBR之间建立EBGP PEER 的MP-BGP关系

    1. 注意：ASBR对着各自AS内的RR配置NEXT-HOP-SELF或者将静态路由重分发进入底层协议。
    2. 2b和2a应用场景不同，2A ASBR之间必须直接链接，没有其他设备了。2B ASBR之间可以有其他若干设备，所以才需要MPLS，栈顶标签，帮忙穿越。


    ！！！要设置EBGP多跳（因为EBGP之间默认是1跳，用的是环回口）

        show ip bgp vpnv4 all
        show ip bgp vpnv4 all tabel

4. OPTION  C
    1. ASBR形成直连网络的EBGP  PEER关系，并且共享标签信息。
    2. ASBR上将各自AS的PE设备和RR设备lo 0接口而宣告进BGP
    3. 各自AS设备RR利用LOOPBACK接口创建BGP和MP-BGP PEER关系，MP-BGP  PEER 关系中设置NEXT-HOP-UNCHANGE(下一跳不改变)

        ！！EBGP PEER 间交换路由信息时，会改变下一跳地址，更新发送者会成为新下一跳，NEXT-HOP-UNCHANGE就是不允许改变下一跳地址。
    4. ASBR上将从对端学习的BGP路由重分发进底层。
    5. 注意

        1. send-label的作用

            关于下一跳的栈顶标签和目标网络的栈底标签都发送给对端BGP  PEER
        2. ASBR 间 常规BGP的作用

            宣告各自AS  PE 和RR的地址，让对方学习。

            目的是为了帮助RR利用地址建立MP-BGP  PEER 关系

            宣告PE的地址是为了 NEXT-HOP-UNCHANGE后，下一跳可达，也是为了对方将这个下一跳地址重分发进底层协议。
        3.     ASBR BGP 下设置权重

            目的是为了保障ASBR抵达对端路由，永远走正确的路径
        4. RR建立MP-BGP PEER关系和NEXT-HOP-UNCHANGE目的

            RR通常是P-NETWORK的核心设备，核心设备直接交换路由信息，再反射给PE

            NEXT-HOP-UNCHANGE为了让PE感受是在直接交换路由。
        5.    PE设备上将BGP路由重分发进IGPS

            目的是为了LDP给这些路由分配标签。
</code></pre><ol>
<li><p>跨域的MPLS  VPN总结</p>
<ol>
<li><p>ORTION  C：方法C</p>
<p>实际运用场景为特大运营网络，让P设备直接交换信息，而不是PE</p>
<ol>
<li>设置权重控制选路 </li>
<li>栈底标签sendlabel </li>
<li><p>栈顶标签用重分发解决</p>
<pre><code>口诀：

ASBR间常规BGP，宣告是为了RR（P设备）建立MP-BGP PEER关系
ASBR上WEIGHT设置是为了避免走错误路径
ASBR上SENDLABEL是为了将最终下一跳栈顶标签和原本的栈底标签共享出去
ASBR上将学习的对端PE网络路由重分发进底层，是为了底层的标签分配
</code></pre></li>
</ol>
<p>最终实现了PE看似和PE的路由信息直接共享，标签的关联。</p>
<p>特色：ASBR间没有MP-BGP   ASBR间没有MPLS</p>
<p>！！  mpls  bgp  forwarding  （让设备能处理带标签的数据，有的设备是配SENDLABEL自动出来的，有的设备没有）</p>
</li>
<li><p>OPTION B 2B</p>
<pre><code>ASBR上关闭RT筛选
ASBR 间启用MPL 
ASBR间启用MP-BGP PEER 关系（利用对端loopback接口，需要静态路由）
ASBR 对着RR做NEXT-HOP-SELF
</code></pre><p> 特色：ASBR间只要启用了MPLS，实际上ASBR不需要直连，有MPLS就可以帮助数据穿越路由黑洞</p>
</li>
<li><p>OPTION B 2A</p>
<pre><code>ASBR上关闭RT筛选
ASBR间启用MP-BGP PEER 关系（利用直连网络建立的BGP PEER 关系）
</code></pre><p> 特色：ASBR间没有MPLS，数据在ASBR间直接IP 包传递，所以ASBR间只能直连</p>
<ol>
<li><p>OPTION  A BACK TO BACK</p>
<p>  ASBR启用VRF，将对端当做CE<br>特色：ASBR间没有MPLS，数据在ASBR间也是IP包传递，只能直连</p>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="参考书籍"><a href="#参考书籍" class="headerlink" title="参考书籍"></a>参考书籍</h2><pre><code>mpls te
</code></pre>
      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://dmonster.top/2017/11/24/MPLS/" data-id="cjey03lld000hvsugxpv5lvwy" class="article-share-link" data-share="baidu" data-title="MPLS">分享到</a>
      

      
        <a href="http://dmonster.top/2017/11/24/MPLS/#ds-thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CCIE/">CCIE</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/11/25/多播/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">
        
          多播
        
      </div>
    </a>
  
  
    <a href="/2017/09/23/CCNA/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">CCNA</div>
    </a>
  
</nav>

  
</article>


  <section id="comments">
    <div id="ds-thread" class="ds-thread" data-thread-key="2017/11/24/MPLS/" data-title="MPLS" data-url="http://dmonster.top/2017/11/24/MPLS/"></div>
  </section>
</section>
      
      <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/实验/">实验</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/笔记/">笔记</a><span class="category-list-count">15</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CCIE/">CCIE</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CCNA/">CCNA</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CCNP/">CCNP</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/学习笔记/">学习笔记</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/爬虫/">爬虫</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络安全/">网络安全</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">6</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/03/19/django强行入门——链接mysql数据库/">django强行入门——链接mysql数据库</a>
          </li>
        
          <li>
            <a href="/2018/03/18/pycharm-professional安装遇到的小麻烦/">pycharm professional安装遇到的小麻烦</a>
          </li>
        
          <li>
            <a href="/2017/12/02/网络安全/">网络安全</a>
          </li>
        
          <li>
            <a href="/2017/11/25/ISIS/">ISIS</a>
          </li>
        
          <li>
            <a href="/2017/11/25/多播/">多播</a>
          </li>
        
      </ul>
    </div>
  </div>

  
     
	<div class="widget-wrap"> 
		<h3 class="widget-title">Weibo show</h3> 
		<div class="widget-weibo"> 
			<iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=5&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=5753916666&verifier=c645597d&dpc=1"></iframe>
		</div> 
	</div> 

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 dmonster<br>
      Powered by <a href="//hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/sitemap.xml" class="mobile-nav-link">sitemap</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="返回顶部"><img src="/img/scrollup.png"/></a>
</div>

<!-- totop end -->

<!-- 多说公共js代码 start -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"reqianduan"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共js代码 end -->


<!-- 百度分享 start -->

<div id="article-share-box" class="article-share-box">
  <div id="bdshare" class="bdsharebuttonbox article-share-links">
    <a class="article-share-weibo" data-cmd="tsina" title="分享到新浪微博"></a>
    <a class="article-share-weixin" data-cmd="weixin" title="分享到微信"></a>
    <a class="article-share-qq" data-cmd="sqq" title="分享到QQ"></a>
    <a class="article-share-renren" data-cmd="renren" title="分享到人人网"></a>
    <a class="article-share-more" data-cmd="more" title="更多"></a>
  </div>
</div>
<script>
  function SetShareData(cmd, config) {
    if (shareDataTitle && shareDataUrl) {
      config.bdText = shareDataTitle;
      config.bdUrl = shareDataUrl;
    }
    return config;
  }
  window._bd_share_config={
    "common":{onBeforeClick: SetShareData},
    "share":{"bdCustomStyle":"/css/bdshare.css"}
  };
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

<!-- 百度分享 end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/script.js"></script>

</div>
</body>
</html>
